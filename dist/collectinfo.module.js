import{record as e,pack as t}from"rrweb";var r;!function(e){e[e.URGENT=1]="URGENT",e[e.IDLE=2]="IDLE"}(r||(r={}));var n=window,o=n.console,i=document,a=n.navigator,c=n.performance,s=function(){var e;return null!=(e=a.deviceMemory)?e:0},l=function(){var e;return null!=(e=a.hardwareConcurrency)?e:0},u=/*#__PURE__*/function(){function e(e){this.logUrl=void 0;var t=e.logUrl;if(!t)throw new Error("请传递要记录数据的路由接口");this.logUrl=t}return e.prototype.sendToAnalytics=function(e,t,o){o&&(this.logUrl=o);var i=this.logUrl;if(e==r.URGENT)if(n.fetch)fetch(i,{headers:{module:d.module.toString()},body:t.toString(),method:"POST",keepalive:!0});else{var c=new XMLHttpRequest;c.setRequestHeader("Content-Type","application/json"),c.setRequestHeader("module",d.module.toString()),c.send(t.toString()),c.onload=function(e){c=null}}else if(e==r.IDLE)if(a.sendBeacon)navigator.sendBeacon(i,t.toString());else{var s=new Image;s.src=i+"?body="+t,s.onload=function(){s=null}}},e}(),d={logUrl:"",reportData:new u({logUrl:"hole"}),isResourceTiming:!1,isElementTiming:!1,maxTime:15e3,isRrweb:!0,rrwebUrl:"",permaceUrl:"",module:""},f=function(e){e.module=d.module,d.reportData.sendToAnalytics(r.IDLE,e,d.permaceUrl)},m=/*#__PURE__*/function(){function o(){this.errordefo=void 0,this.eventsMatrix=void 0,this.errordefo={},this.eventsMatrix=[[]]}var i=o.prototype;return i.globalError=function(){var e=this;n.onerror=function(t,n,o,i,a){var c=JSON.stringify({scriptURL:n,lineno:o,colno:i,error:a,module:d.module});d.reportData.sendToAnalytics(r.URGENT,c,d.logUrl);var s,l=e.eventsMatrix.length;s=l>1?e.eventsMatrix[l-2].concat(e.eventsMatrix[l-1]):e.eventsMatrix[0];var u=JSON.stringify({events:s,module:d.module});return d.reportData.sendToAnalytics(r.IDLE,u,d.rrwebUrl),e.eventsMatrix=[[]],e.recordPage(),!0}},i.networkError=function(){n.addEventListener("error",function(e){e.target!==n&&console.log("网络错误",e.target)},!0)},i.promiseError=function(){n.addEventListener("unhandledrejection",function(e){return e.preventDefault(),console.log("promiseError",e.reason),!0})},i.iframeError=function(){for(var e=n.frames,t=0;t<e.length;t++)e[t].addEventListener("error",function(e){console.log("iframe加载错误",e)},!0),e[t].addEventListener("unhandledrejection",function(e){console.log("iframe错误_unhandledrejection",e)},!0)},i.consoleReflect=function(){n.console.error=function(){}},i.recordPage=function(){if(d.isRrweb){var r=this.eventsMatrix;e({emit:function(e,t){t&&r.push([]),r[r.length-1].push(e)},checkoutEveryNth:10,packFn:t})}},i.run=function(){this.networkError(),this.globalError(),this.promiseError(),this.recordPage()},o}(),v="4g",p=!1,g=function(){return!!(l()&&l()<=4)||!!(s()&&s()<=4)},h=function(e,t){switch(e){case"slow-2g":case"2g":case"3g":return!0;default:return g()||t}},T={isHidden:!1},E=function(e){i.hidden&&(e(),T.isHidden=i.hidden)},y=function(e){return parseFloat(e.toFixed(2))},w=function(e){return"number"!=typeof e?null:y(e/Math.pow(1024,2))},b=[1e3,2500],k=[2500,4e3],S=[100,300],U=[.1,.25],R=[300,600],D={fp:b,fcp:b,lcp:k,lcpFinal:k,fid:S,fidVitals:S,cls:U,clsFinal:U,tbt:R,tbt5S:R,tbt10S:R,tbtFinal:R},x=function(e,t){return D[e]?t<=D[e][0]?"good":t<=D[e][1]?"needsImprovement":"poor":null},L=function(e,t,r){var o;o=function(){T.isHidden&&e.indexOf("Final")<0||!d.analyticsTracker||d.analyticsTracker({metricName:e,data:t,eventProperties:r||{},navigatorInformation:a?{deviceMemory:s()||0,hardwareConcurrency:l()||0,serviceWorkerStatus:"serviceWorker"in a?a.serviceWorker.controller?"controlled":"supported":"unsupported",isLowEndDevice:g(),isLowEndExperience:h(v,p)}:{},vitalsScore:x(e,t)})},"requestIdleCallback"in n?n.requestIdleCallback(o,{timeout:3e3}):o()},M=function(e,t,r){Object.keys(t).forEach(function(e){"number"==typeof t[e]&&(t[e]=y(t[e]))}),L(e,t,r)},I=function(e,t,r){var n=y(e);n<=d.maxTime&&n>=0&&L(t,n,r)},B={value:0},F={value:0},q={value:0},C={value:{beacon:0,css:0,fetch:0,img:0,other:0,script:0,total:0,xmlhttprequest:0}},N={value:0},j=function(e){var t=e.pop();t&&!t.hadRecentInput&&t.value&&(B.value+=t.value)},O={},P=function(e,t){try{var r=new PerformanceObserver(function(e){t(e.getEntries())});return r.observe({type:e,buffered:!0}),r}catch(e){o.warn("Yideng.js:",e)}return null},H=function(e){O[e]&&O[e].disconnect(),delete O[e]},z=function(e){var t=e.pop();t&&(I(t.processingStart-t.startTime,"fidVitals",{performanceEntry:t}),I(t.duration,"fid",{performanceEntry:t})),H(1),I(q.value,"lcp"),O[3]&&"function"==typeof O[3].takeRecords&&O[3].takeRecords(),I(B.value,"cls"),I(N.value,"tbt"),setTimeout(function(){I(N.value,"tbt5S")},5e3),setTimeout(function(){I(N.value,"tbt10S"),M("dataConsumption",C.value)},1e4)},W=function(e){e.forEach(function(e){if(!("self"!==e.name||e.startTime<F.value)){var t=e.duration-50;t>0&&(N.value+=t)}})},A=function(e){e.forEach(function(e){"first-paint"===e.name?I(e.startTime,"fp"):"first-contentful-paint"===e.name&&(F.value=e.startTime,I(F.value,"fcp"),O[4]=P("longtask",W),H(0))})},G=function(e){var t=e.pop();t&&(q.value=t.renderTime||t.loadTime)},J=function(e){e.forEach(function(e){e.identifier&&I(e.startTime,e.identifier)})},V=function(e){e.forEach(function(e){if(d.isResourceTiming&&M("resourceTiming",e),e.decodedBodySize&&e.initiatorType){var t=e.decodedBodySize/1e3;C.value[e.initiatorType]+=t,C.value.total+=t}})},X=function(){O[2]&&(I(q.value,"lcpFinal"),H(2)),O[3]&&("function"==typeof O[3].takeRecords&&O[3].takeRecords(),I(B.value,"clsFinal"),H(3)),O[4]&&(I(N.value,"tbtFinal"),H(4))},Y=function(e){var t="usageDetails"in e?e.usageDetails:{};M("storageEstimate",{quota:w(e.quota),usage:w(e.usage),caches:w(t.caches),indexedDB:w(t.indexedDB),serviceWorker:w(t.serviceWorkerRegistrations)})},_=function(e){void 0===e&&(e={permaceUrl:"",rrwebUrl:"",module:""}),this.v="1.0.0",this.reportData=void 0;var t=e.logUrl;if(!t)throw new Error("小石头系统监控平台"+this.v+"提示未传递上报服务地址");var r=new u({logUrl:t});d.reportData=r,this.reportData=r,d.analyticsTracker=e.analyticsTracker||f,d.isResourceTiming=!!e.resourceTiming,d.isElementTiming=!!e.elementTiming,d.maxTime=e.maxMeasureTime||d.maxTime,d.isRrweb=e.isRrweb||d.isRrweb,d.rrwebUrl=e.rrwebUrl||d.rrwebUrl,d.permaceUrl=e.permaceUrl||d.permaceUrl,d.logUrl=e.logUrl||d.logUrl,d.module=e.module||d.module,e.captureError&&(new m).run(),c&&c.getEntriesByType&&c.now&&c.mark&&("PerformanceObserver"in n&&(console.log("⏰ 性能收集开始",Math.random()),O[0]=P("paint",A),O[1]=P("first-input",z),O[2]=P("largest-contentful-paint",G),d.isResourceTiming&&(console.log("📚 收集页面性能数据"),P("resource",V)),O[3]=P("layout-shift",j),d.isElementTiming&&P("element",J)),void 0!==i.hidden&&i.addEventListener("visibilitychange",E.bind(this,X)),M("navigationTiming",function(){if(!(c&&c.getEntriesByType&&c.now&&c.mark))return{};var e=c.getEntriesByType("navigation")[0];if(!e)return{};var t=e.responseStart,r=e.responseEnd;return{fetchTime:r-e.fetchStart,workerTime:e.workerStart>0?r-e.workerStart:0,totalTime:r-e.requestStart,downloadTime:r-t,timeToFirstByte:t-e.requestStart,headerSize:e.transferSize-e.encodedBodySize||0,dnsLookupTime:e.domainLookupEnd-e.domainLookupStart,tcpTime:e.connectEnd-e.connectStart||0,whiteTime:e.responseStart-e.navigationStart||0,domTime:e.domContentLoadedEventEnd-e.navigationStart||0,loadTime:e.loadEventEnd-e.navigationStart||0,parseDomTime:e.domComplete-e.domInteractive||0}}()),M("networkInformation",function(){if("connection"in a){var e=a.connection;return"object"!=typeof e?{}:(v=e.effectiveType,p=!!e.saveData,{downlink:e.downlink,effectiveType:e.effectiveType,rtt:e.rtt,saveData:!!e.saveData})}return{}}()),a&&a.storage&&"function"==typeof a.storage.estimate&&a.storage.estimate().then(Y))};export{_ as default};
//# sourceMappingURL=collectinfo.module.js.map
