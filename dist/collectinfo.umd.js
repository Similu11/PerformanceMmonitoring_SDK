!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("rrweb")):"function"==typeof define&&define.amd?define(["rrweb"],t):(e||self).sdkmodel=t(e.rrweb)}(this,function(e){var t;!function(e){e[e.URGENT=1]="URGENT",e[e.IDLE=2]="IDLE"}(t||(t={}));var r=window,n=r.console,o=document,i=r.navigator,a=r.performance,c=function(){var e;return null!=(e=i.deviceMemory)?e:0},s=function(){var e;return null!=(e=i.hardwareConcurrency)?e:0},l=/*#__PURE__*/function(){function e(e){this.logUrl=void 0;var t=e.logUrl;if(!t)throw new Error("请传递要记录数据的路由接口");this.logUrl=t}return e.prototype.sendToAnalytics=function(e,n,o){o&&(this.logUrl=o);var a=this.logUrl;if(e==t.URGENT)if(r.fetch)fetch(a,{headers:{module:u.module.toString()},body:n.toString(),method:"POST",keepalive:!0});else{var c=new XMLHttpRequest;c.setRequestHeader("Content-Type","application/json"),c.setRequestHeader("module",u.module.toString()),c.send(n.toString()),c.onload=function(e){c=null}}else if(e==t.IDLE)if(i.sendBeacon)navigator.sendBeacon(a,n.toString());else{var s=new Image;s.src=a+"?body="+n,s.onload=function(){s=null}}},e}(),u={logUrl:"",reportData:new l({logUrl:"hole"}),isResourceTiming:!1,isElementTiming:!1,maxTime:15e3,isRrweb:!0,rrwebUrl:"",permaceUrl:"",module:""},d=function(e){e.module=u.module,u.reportData.sendToAnalytics(t.IDLE,e,u.permaceUrl)},f=/*#__PURE__*/function(){function n(){this.errordefo=void 0,this.eventsMatrix=void 0,this.errordefo={},this.eventsMatrix=[[]]}var o=n.prototype;return o.globalError=function(){var e=this;r.onerror=function(r,n,o,i,a){var c=JSON.stringify({scriptURL:n,lineno:o,colno:i,error:a,module:u.module});u.reportData.sendToAnalytics(t.URGENT,c,u.logUrl);var s,l=e.eventsMatrix.length;s=l>1?e.eventsMatrix[l-2].concat(e.eventsMatrix[l-1]):e.eventsMatrix[0];var d=JSON.stringify({events:s,module:u.module});return u.reportData.sendToAnalytics(t.IDLE,d,u.rrwebUrl),e.eventsMatrix=[[]],e.recordPage(),!0}},o.networkError=function(){r.addEventListener("error",function(e){e.target!==r&&console.log("网络错误",e.target)},!0)},o.promiseError=function(){r.addEventListener("unhandledrejection",function(e){return e.preventDefault(),console.log("promiseError",e.reason),!0})},o.iframeError=function(){for(var e=r.frames,t=0;t<e.length;t++)e[t].addEventListener("error",function(e){console.log("iframe加载错误",e)},!0),e[t].addEventListener("unhandledrejection",function(e){console.log("iframe错误_unhandledrejection",e)},!0)},o.consoleReflect=function(){r.console.error=function(){}},o.recordPage=function(){if(u.isRrweb){var t=this.eventsMatrix;e.record({emit:function(e,r){r&&t.push([]),t[t.length-1].push(e)},checkoutEveryNth:10,packFn:e.pack})}},o.run=function(){this.networkError(),this.globalError(),this.promiseError(),this.recordPage()},n}(),m="4g",v=!1,p=function(){return!!(s()&&s()<=4)||!!(c()&&c()<=4)},g=function(e,t){switch(e){case"slow-2g":case"2g":case"3g":return!0;default:return p()||t}},h={isHidden:!1},T=function(e){o.hidden&&(e(),h.isHidden=o.hidden)},y=function(e){return parseFloat(e.toFixed(2))},E=function(e){return"number"!=typeof e?null:y(e/Math.pow(1024,2))},w=[1e3,2500],b=[2500,4e3],k=[100,300],S=[.1,.25],U=[300,600],R={fp:w,fcp:w,lcp:b,lcpFinal:b,fid:k,fidVitals:k,cls:S,clsFinal:S,tbt:U,tbt5S:U,tbt10S:U,tbtFinal:U},D=function(e,t){return R[e]?t<=R[e][0]?"good":t<=R[e][1]?"needsImprovement":"poor":null},x=function(e,t,n){var o;o=function(){h.isHidden&&e.indexOf("Final")<0||!u.analyticsTracker||u.analyticsTracker({metricName:e,data:t,eventProperties:n||{},navigatorInformation:i?{deviceMemory:c()||0,hardwareConcurrency:s()||0,serviceWorkerStatus:"serviceWorker"in i?i.serviceWorker.controller?"controlled":"supported":"unsupported",isLowEndDevice:p(),isLowEndExperience:g(m,v)}:{},vitalsScore:D(e,t)})},"requestIdleCallback"in r?r.requestIdleCallback(o,{timeout:3e3}):o()},L=function(e,t,r){Object.keys(t).forEach(function(e){"number"==typeof t[e]&&(t[e]=y(t[e]))}),x(e,t,r)},M=function(e,t,r){var n=y(e);n<=u.maxTime&&n>=0&&x(t,n,r)},I={value:0},q={value:0},B={value:0},F={value:{beacon:0,css:0,fetch:0,img:0,other:0,script:0,total:0,xmlhttprequest:0}},j={value:0},C=function(e){var t=e.pop();t&&!t.hadRecentInput&&t.value&&(I.value+=t.value)},N={},O=function(e,t){try{var r=new PerformanceObserver(function(e){t(e.getEntries())});return r.observe({type:e,buffered:!0}),r}catch(e){n.warn("Yideng.js:",e)}return null},P=function(e){N[e]&&N[e].disconnect(),delete N[e]},H=function(e){var t=e.pop();t&&(M(t.processingStart-t.startTime,"fidVitals",{performanceEntry:t}),M(t.duration,"fid",{performanceEntry:t})),P(1),M(B.value,"lcp"),N[3]&&"function"==typeof N[3].takeRecords&&N[3].takeRecords(),M(I.value,"cls"),M(j.value,"tbt"),setTimeout(function(){M(j.value,"tbt5S")},5e3),setTimeout(function(){M(j.value,"tbt10S"),L("dataConsumption",F.value)},1e4)},z=function(e){e.forEach(function(e){if(!("self"!==e.name||e.startTime<q.value)){var t=e.duration-50;t>0&&(j.value+=t)}})},W=function(e){e.forEach(function(e){"first-paint"===e.name?M(e.startTime,"fp"):"first-contentful-paint"===e.name&&(q.value=e.startTime,M(q.value,"fcp"),N[4]=O("longtask",z),P(0))})},A=function(e){var t=e.pop();t&&(B.value=t.renderTime||t.loadTime)},G=function(e){e.forEach(function(e){e.identifier&&M(e.startTime,e.identifier)})},J=function(e){e.forEach(function(e){if(u.isResourceTiming&&L("resourceTiming",e),e.decodedBodySize&&e.initiatorType){var t=e.decodedBodySize/1e3;F.value[e.initiatorType]+=t,F.value.total+=t}})},V=function(){N[2]&&(M(B.value,"lcpFinal"),P(2)),N[3]&&("function"==typeof N[3].takeRecords&&N[3].takeRecords(),M(I.value,"clsFinal"),P(3)),N[4]&&(M(j.value,"tbtFinal"),P(4))},X=function(e){var t="usageDetails"in e?e.usageDetails:{};L("storageEstimate",{quota:E(e.quota),usage:E(e.usage),caches:E(t.caches),indexedDB:E(t.indexedDB),serviceWorker:E(t.serviceWorkerRegistrations)})};return function(e){void 0===e&&(e={permaceUrl:"",rrwebUrl:"",module:""}),this.v="1.0.0",this.reportData=void 0;var t=e.logUrl;if(!t)throw new Error("小石头系统监控平台"+this.v+"提示未传递上报服务地址");var n=new l({logUrl:t});u.reportData=n,this.reportData=n,u.analyticsTracker=e.analyticsTracker||d,u.isResourceTiming=!!e.resourceTiming,u.isElementTiming=!!e.elementTiming,u.maxTime=e.maxMeasureTime||u.maxTime,u.isRrweb=e.isRrweb||u.isRrweb,u.rrwebUrl=e.rrwebUrl||u.rrwebUrl,u.permaceUrl=e.permaceUrl||u.permaceUrl,u.logUrl=e.logUrl||u.logUrl,u.module=e.module||u.module,e.captureError&&(new f).run(),a&&a.getEntriesByType&&a.now&&a.mark&&("PerformanceObserver"in r&&(console.log("⏰ 性能收集开始",Math.random()),N[0]=O("paint",W),N[1]=O("first-input",H),N[2]=O("largest-contentful-paint",A),u.isResourceTiming&&(console.log("📚 收集页面性能数据"),O("resource",J)),N[3]=O("layout-shift",C),u.isElementTiming&&O("element",G)),void 0!==o.hidden&&o.addEventListener("visibilitychange",T.bind(this,V)),L("navigationTiming",function(){if(!(a&&a.getEntriesByType&&a.now&&a.mark))return{};var e=a.getEntriesByType("navigation")[0];if(!e)return{};var t=e.responseStart,r=e.responseEnd;return{fetchTime:r-e.fetchStart,workerTime:e.workerStart>0?r-e.workerStart:0,totalTime:r-e.requestStart,downloadTime:r-t,timeToFirstByte:t-e.requestStart,headerSize:e.transferSize-e.encodedBodySize||0,dnsLookupTime:e.domainLookupEnd-e.domainLookupStart,tcpTime:e.connectEnd-e.connectStart||0,whiteTime:e.responseStart-e.navigationStart||0,domTime:e.domContentLoadedEventEnd-e.navigationStart||0,loadTime:e.loadEventEnd-e.navigationStart||0,parseDomTime:e.domComplete-e.domInteractive||0}}()),L("networkInformation",function(){if("connection"in i){var e=i.connection;return"object"!=typeof e?{}:(m=e.effectiveType,v=!!e.saveData,{downlink:e.downlink,effectiveType:e.effectiveType,rtt:e.rtt,saveData:!!e.saveData})}return{}}()),i&&i.storage&&"function"==typeof i.storage.estimate&&i.storage.estimate().then(X))}});
//# sourceMappingURL=collectinfo.umd.js.map
