import{record as e,pack as t}from"rrweb";var r;!function(e){e[e.URGENT=1]="URGENT",e[e.IDLE=2]="IDLE"}(r||(r={}));const o=window,n=o.console,i=document,a=o.navigator,s=o.performance,l=()=>{var e;return null!=(e=a.deviceMemory)?e:0},c=()=>{var e;return null!=(e=a.hardwareConcurrency)?e:0};class d{constructor(e){this.logUrl=void 0;const{logUrl:t}=e;if(!t)throw new Error("请传递要记录数据的路由接口");this.logUrl=t}sendToAnalytics(e,t,n){n&&(this.logUrl=n);let i=this.logUrl;if(e==r.URGENT)if(o.fetch)fetch(i,{headers:{module:u.module.toString()},body:t.toString(),method:"POST",keepalive:!0});else{let e=new XMLHttpRequest;e.setRequestHeader("Content-Type","application/json"),e.setRequestHeader("module",u.module.toString()),e.send(t.toString()),e.onload=function(t){e=null}}else if(e==r.IDLE)if(a.sendBeacon)navigator.sendBeacon(i,t.toString());else{let e=new Image;e.src=`${i}?body=${t}`,e.onload=function(){e=null}}}}const u={logUrl:"",reportData:new d({logUrl:"hole"}),isResourceTiming:!1,isElementTiming:!1,maxTime:15e3,isRrweb:!0,rrwebUrl:"",permaceUrl:"",module:""},m=e=>{e.module=u.module,u.reportData.sendToAnalytics(r.IDLE,e,u.permaceUrl)};class p{constructor(){this.errordefo=void 0,this.eventsMatrix=void 0,this.errordefo={},this.eventsMatrix=[[]]}globalError(){o.onerror=(e,t,o,n,i)=>{const a=JSON.stringify({scriptURL:t,lineno:o,colno:n,error:i,module:u.module});u.reportData.sendToAnalytics(r.URGENT,a,u.logUrl);const s=this.eventsMatrix.length;let l=[];l=s>1?this.eventsMatrix[s-2].concat(this.eventsMatrix[s-1]):this.eventsMatrix[0];const c=JSON.stringify({events:l,module:u.module});return u.reportData.sendToAnalytics(r.IDLE,c,u.rrwebUrl),this.eventsMatrix=[[]],this.recordPage(),!0}}networkError(){o.addEventListener("error",function(e){e.target!==o&&console.log("网络错误",e.target)},!0)}promiseError(){o.addEventListener("unhandledrejection",function(e){return e.preventDefault(),console.log("promiseError",e.reason),!0})}iframeError(){const e=o.frames;for(let t=0;t<e.length;t++)e[t].addEventListener("error",e=>{console.log("iframe加载错误",e)},!0),e[t].addEventListener("unhandledrejection",function(e){console.log("iframe错误_unhandledrejection",e)},!0)}consoleReflect(){o.console.error=function(){}}recordPage(){if(u.isRrweb){let r=this.eventsMatrix;e({emit(e,t){t&&r.push([]),r[r.length-1].push(e)},checkoutEveryNth:10,packFn:t})}}run(){this.networkError(),this.globalError(),this.promiseError(),this.recordPage()}}let f="4g",v=!1;const g=()=>!!(c()&&c()<=4)||!!(l()&&l()<=4),h=(e,t)=>{switch(e){case"slow-2g":case"2g":case"3g":return!0;default:return g()||t}},T={isHidden:!1},E=function(e){i.hidden&&(e(),T.isHidden=i.hidden)},y=e=>parseFloat(e.toFixed(2)),w=e=>"number"!=typeof e?null:y(e/Math.pow(1024,2)),b=[1e3,2500],k=[2500,4e3],S=[100,300],U=[.1,.25],R=[300,600],D={fp:b,fcp:b,lcp:k,lcpFinal:k,fid:S,fidVitals:S,cls:U,clsFinal:U,tbt:R,tbt5S:R,tbt10S:R,tbtFinal:R},x=(e,t)=>D[e]?t<=D[e][0]?"good":t<=D[e][1]?"needsImprovement":"poor":null,L=function(e,t,r){var n;n=()=>{T.isHidden&&e.indexOf("Final")<0||!u.analyticsTracker||u.analyticsTracker({metricName:e,data:t,eventProperties:r||{},navigatorInformation:a?{deviceMemory:l()||0,hardwareConcurrency:c()||0,serviceWorkerStatus:"serviceWorker"in a?a.serviceWorker.controller?"controlled":"supported":"unsupported",isLowEndDevice:g(),isLowEndExperience:h(f,v)}:{},vitalsScore:x(e,t)})},"requestIdleCallback"in o?o.requestIdleCallback(n,{timeout:3e3}):n()},M=(e,t,r)=>{Object.keys(t).forEach(e=>{"number"==typeof t[e]&&(t[e]=y(t[e]))}),L(e,t,r)},I=(e,t,r)=>{const o=y(e);o<=u.maxTime&&o>=0&&L(t,o,r)},B={value:0},F={value:0},q={value:0},C={value:{beacon:0,css:0,fetch:0,img:0,other:0,script:0,total:0,xmlhttprequest:0}},N={value:0},j=e=>{const t=e.pop();t&&!t.hadRecentInput&&t.value&&(B.value+=t.value)},O={},P=(e,t)=>{try{const r=new PerformanceObserver(e=>{t(e.getEntries())});return r.observe({type:e,buffered:!0}),r}catch(e){n.warn("Yideng.js:",e)}return null},H=e=>{O[e]&&O[e].disconnect(),delete O[e]},z=e=>{const t=e.pop();t&&(I(t.processingStart-t.startTime,"fidVitals",{performanceEntry:t}),I(t.duration,"fid",{performanceEntry:t})),H(1),I(q.value,"lcp"),O[3]&&"function"==typeof O[3].takeRecords&&O[3].takeRecords(),I(B.value,"cls"),I(N.value,"tbt"),setTimeout(()=>{I(N.value,"tbt5S")},5e3),setTimeout(()=>{I(N.value,"tbt10S"),M("dataConsumption",C.value)},1e4)},W=e=>{e.forEach(e=>{if("self"!==e.name||e.startTime<F.value)return;const t=e.duration-50;t>0&&(N.value+=t)})},A=e=>{e.forEach(e=>{"first-paint"===e.name?I(e.startTime,"fp"):"first-contentful-paint"===e.name&&(F.value=e.startTime,I(F.value,"fcp"),O[4]=P("longtask",W),H(0))})},G=e=>{const t=e.pop();t&&(q.value=t.renderTime||t.loadTime)},$=e=>{e.forEach(e=>{e.identifier&&I(e.startTime,e.identifier)})},J=e=>{e.forEach(e=>{if(u.isResourceTiming&&M("resourceTiming",e),e.decodedBodySize&&e.initiatorType){const t=e.decodedBodySize/1e3;C.value[e.initiatorType]+=t,C.value.total+=t}})},V=()=>{O[2]&&(I(q.value,"lcpFinal"),H(2)),O[3]&&("function"==typeof O[3].takeRecords&&O[3].takeRecords(),I(B.value,"clsFinal"),H(3)),O[4]&&(I(N.value,"tbtFinal"),H(4))},X=e=>{const t="usageDetails"in e?e.usageDetails:{};M("storageEstimate",{quota:w(e.quota),usage:w(e.usage),caches:w(t.caches),indexedDB:w(t.indexedDB),serviceWorker:w(t.serviceWorkerRegistrations)})};class Y{constructor(e={permaceUrl:"",rrwebUrl:"",module:""}){this.v="1.0.0",this.reportData=void 0;const t=e.logUrl;if(!t)throw new Error(`小石头系统监控平台${this.v}提示未传递上报服务地址`);const r=new d({logUrl:t});u.reportData=r,this.reportData=r,u.analyticsTracker=e.analyticsTracker||m,u.isResourceTiming=!!e.resourceTiming,u.isElementTiming=!!e.elementTiming,u.maxTime=e.maxMeasureTime||u.maxTime,u.isRrweb=e.isRrweb||u.isRrweb,u.rrwebUrl=e.rrwebUrl||u.rrwebUrl,u.permaceUrl=e.permaceUrl||u.permaceUrl,u.logUrl=e.logUrl||u.logUrl,u.module=e.module||u.module,e.captureError&&(new p).run(),s&&s.getEntriesByType&&s.now&&s.mark&&("PerformanceObserver"in o&&(console.log("⏰ 性能收集开始",Math.random()),O[0]=P("paint",A),O[1]=P("first-input",z),O[2]=P("largest-contentful-paint",G),u.isResourceTiming&&(console.log("📚 收集页面性能数据"),P("resource",J)),O[3]=P("layout-shift",j),u.isElementTiming&&P("element",$)),void 0!==i.hidden&&i.addEventListener("visibilitychange",E.bind(this,V)),M("navigationTiming",(()=>{if(!(s&&s.getEntriesByType&&s.now&&s.mark))return{};const e=s.getEntriesByType("navigation")[0];if(!e)return{};const t=e.responseStart,r=e.responseEnd;return{fetchTime:r-e.fetchStart,workerTime:e.workerStart>0?r-e.workerStart:0,totalTime:r-e.requestStart,downloadTime:r-t,timeToFirstByte:t-e.requestStart,headerSize:e.transferSize-e.encodedBodySize||0,dnsLookupTime:e.domainLookupEnd-e.domainLookupStart,tcpTime:e.connectEnd-e.connectStart||0,whiteTime:e.responseStart-e.navigationStart||0,domTime:e.domContentLoadedEventEnd-e.navigationStart||0,loadTime:e.loadEventEnd-e.navigationStart||0,parseDomTime:e.domComplete-e.domInteractive||0}})()),M("networkInformation",(()=>{if("connection"in a){const e=a.connection;return"object"!=typeof e?{}:(f=e.effectiveType,v=!!e.saveData,{downlink:e.downlink,effectiveType:e.effectiveType,rtt:e.rtt,saveData:!!e.saveData})}return{}})()),a&&a.storage&&"function"==typeof a.storage.estimate&&a.storage.estimate().then(X))}}export{Y as default};
//# sourceMappingURL=collectinfo.modern.js.map
